<!DOCTYPE html>
<html lang="en"><head>
    <!-- Include from _includes/head -->
    <!-- Charset -->
    <meta charset="utf-8" />
    <!-- Compatibility -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Page Title --><title>Timeworn Peisteskin Map | FFXIV Pocket Guide - Final Fantasy XIV - Dawntrail</title><!-- Page Description -->
    <meta name="description" content="Dungeon, Trial, and Raid guides for Final Fantasy XIV.A collection of mobile friendly guides to help players navigate group content in Final Fantasy XIV. Guide content has been compiled from video guides produced by MTQCapture.
" />
    <!-- Open Graph & Twitter Tags -->
    <meta name="twitter:card" content="summary" />
    <meta property="og:url" content="/treasuremap/vergilbte-basiliskenleder-karte.html" />
    <meta property="og:title" content="Timeworn Peisteskin Map| FFXIV Pocket Guide - Final Fantasy XIV - Dawntrail" />
    <meta property="og:description" content="Dungeon, Trial, and Raid guides for Final Fantasy XIV.A collection of mobile friendly guides to help players navigate group content in Final Fantasy XIV. Guide content has been compiled from video guides produced by MTQCapture.
" /><meta property="og:image" content="" /><!-- Google Fonts -->
    <link href="/assets/fonts/fonts.css" rel="stylesheet" />
    <!--  Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#ff575c" />
    <meta name="theme-color" content="#ffffff" />
    <!-- Google Search Structured Pages --><script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "headline": "Timeworn Peisteskin Map",
        "image": [
          ""
        ]
      }
    </script><!-- Twitter Intents -->
    <script type="text/javascript" async src="https://platform.twitter.com/widgets.js"></script>
    <!-- jQuery -->
    <script type="text/javascript" src="/assets/vendor/jquery.min.js?1770419310945723427"></script>
    <!-- Modernizr -->
    <script type="text/javascript" src="/assets/vendor/modernizr.js?1770419310945723427"></script>
    <!-- Ionicons -->
    <link rel="stylesheet" href="/assets/vendor/ionicons.min.css?1770419310945723427" type="text/css" media="all" />
    <!-- Normalize -->
    <link rel="stylesheet" href="/assets/vendor/normalize.css?1770419310945723427" type="text/css" media="all" />
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="/css/core.css?1770419310945723427" />
    <script type="text/javascript" src="/assets/js/copy2clipboard.js?1770419310945723427"></script>
    <script type="text/javascript" src="/assets/js/handleLanguage.js?1770419310945723427"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="/css/ffxiv.css">
    <script type="text/javascript" src="/assets/js/leaflet.js?1770419310945723427"></script>
    <script type="text/javascript" src="/assets/js/tablesort.min.js?1770419310945723427"></script>
    <script type="text/javascript" src="/assets/js/tablesort.number.min.js?1770419310945723427"></script>
    <style>
      @font-face {
          font-family: finalf;
          src: url('/assets/fonts/FFXIV_Lodestone_SSF.ttf');
      }
    </style>
    <script type="text/javascript" src="/assets/js/darkreader.min.js?1770419310945723427"></script>
    <link rel="stylesheet" href="/assets/css/leaflet.css?1770419310945723427" type="text/css" media="all" />
    <link rel="stylesheet" href="/assets/css/leafletmaps.css?1770419310945723427" type="text/css" media="all" />
    <script>
      DarkReader.setFetchMethod(window.fetch)
      DarkReader.enable({brightness: 90,contrast: 100,sepia: 10});
      const isEnabled = DarkReader.isEnabled();
    </script>
    <!-- Include from _includes/head -->
  </head>
  <!-- ORIGIN: _layout/treasuremap -->
  <body class="guide ">
    <div class="layout">
      <!-- Include from _includes/navbar -->
      <!-- Mobile Menu Trigger -->
      <button class="sidebar__trigger">
        <span class="sidebar__trigger-inactive">
          <ion-icon name="chevron-down-outline" style="color: white !important"></ion-icon>
          <div data-translate="Navbar_Mobile_Menu">Menu</div>
        </span>
        <span class="sidebar__trigger-active">
          <ion-icon name="chevron-up-outline" style="color: white !important"></ion-icon>
          <div data-translate="Navbar_Mobile_Close">Close</div>
        </span>
      </button>
      <!-- Mobile Overlay -->
      <div
        class="site-grid__sidebar-overlay">
      </div>
      <!-- Menu -->
      <div
        class="sidebar" loading="lazy"
        style="background-image: url('/assets/img/guide_index_default.webp');">
        <div class="sidebar__wrapper">
          <div class="languages">
            <a loading="lazy" style="background-image: url('/assets/img/flags.webp')" class="flags_img iso_US" onclick="changeLanguageTo('lang-toogle-en', 'en-US')" alt="en"></a>
            <a loading="lazy" style="background-image: url('/assets/img/flags.webp')" class="flags_img iso_DE" onclick="changeLanguageTo('lang-toogle-de', 'de-DE')" alt="de"></a>
            <a loading="lazy" style="background-image: url('/assets/img/flags.webp')" class="flags_img iso_FR" onclick="changeLanguageTo('lang-toogle-fr', 'fr-FR')" alt="fr"></a>
            <a loading="lazy" style="background-image: url('/assets/img/flags.webp')" class="flags_img iso_JP" onclick="changeLanguageTo('lang-toogle-ja', 'ja-JP')" alt="ja"></a>
          </div>
          <h1 class="sidebar__title">
            <a href='/' title="Return to the Pocket Guide Home Page.">
              <img loading="lazy" alt="FFXIV Icon" src='/assets/img/icon.svg'>
            </a>
          </h1>
          <ul class="sidebar__menu">
            <li>
              <a target=""href='/about.html' title="See what's new with the Pocket Guide.">
                <img loading="lazy" src='/assets/img/new.webp' alt="A new icon." style="width: 1.5rem; vertical-align: middle; margin-bottom: .2rem; margin-right: .5rem;">
                <span data-translate="Navbar_About">About</span>
              </a>
            </li>
            <li>
              <a target=""href='/patches/' title="Alle Patches anzeigen">
                <img loading="lazy" src='/assets/img/game_assets//061000/061757_hr1.webp'">
                <span data-translate="Navbar_Patches">Patches</span>
              </a>
            </li>
            <li style="cursor: pointer;"><span><span>&#9660;</span> Extra Tools</span></li>
            <ul style="display: inherit;">
              <li>
                <a target=""href='/translate/' title="See Translations">
                  <img loading="lazy" src='/assets/img/game_assets//uld/launchericon_hr1.tex.webp'">
                  <span data-translate="Navbar_Translations">Translations</span>
                </a>
              </li>
              <li>
                <a target=""href='/gear/' title="See Gear">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061828_hr1.webp'">
                  <span data-translate="Navbar_Equipment">Equipment</span>
                </a>
              </li>
              <li>
                <a target=""href='/fflogs/' title="See fflogs">
                  <img loading="lazy" src='/assets/img/game_assets//060000/060453_hr1.webp'">
                  <span data-translate=" Navbar_FFLogs">FFLogs</span>
                </a>
              </li>
              <li>
                <a target=""href='/checkFileData/' title="See checkFileData">
                  <img loading="lazy" src='/assets/img/game_assets//000000/000046_hr1.webp'">
                  <span data-translate=" Navbar_checkFileData">checkFileData</span>
                </a>
              </li>
              <li>
                <a target=""href='/settings/' title="See settings">
                  <img loading="lazy" src='/assets/img/game_assets//000000/000029_hr1.webp'">
                  <span data-translate=" Navbar_settings">settings</span>
                </a>
              </li>
              <li>
                <a target=""href='/itemsets/' title="See itemsets">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061759_hr1.webp'">
                  <span data-translate=" Navbar_itemsets">itemsets</span>
                </a>
              </li>
              <li>
                <a target=""href='/mainquestsfinder/' title="See mainquestsfinder">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061432_hr1.webp'">
                  <span data-translate=" Navbar_mainquestsfinder">mainquestsfinder</span>
                </a>
              </li>
              <li>
                <a target=""href='/klassenjobs/' title="Klassen/Jobs anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061835_hr1.webp'">
                  <span data-translate="Navbar_Classes/Jobs">Classes/Jobs</span>
                </a>
              </li>
              <li>
                <a target=""href='/relics/' title="Relic Weapons anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061822_hr1.webp'">
                  <span data-translate="Navbar_Relic Weapons">Relic Weapons</span>
                </a>
              </li>
              <li>
                <a target=""href='/airship_submarine/' title="Company Airship & Submersible anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061821_hr1.webp'">
                  <span data-translate="Navbar_Company Airship & Submersible">Company Airship & Submersible</span>
                </a>
              </li>
              <li>
                <a target=""href='/quests/' title="Quests anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061723_hr1.webp'">
                  <span data-translate="Navbar_Quests">Quests</span>
                </a>
              </li>
              <li>
                <a target=""href='/achivments/' title="Achivments anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061767_hr1.webp'">
                  <span data-translate="Navbar_Achievement">Achievement</span>
                </a>
              </li>
              <li>
                <a target=""class="active"href='/treasuremap/' title="GCrank anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//000000/000115_hr1.webp'">
                  <span data-translate="Navbar_treasuremap">TreasureMaps</span>
                </a>
              </li>
              <li>
                <a target=""href='/gcrank/' title="GCrank anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061723_hr1.webp'">
                  <span data-translate="Navbar_GCrank">GCrank</span>
                </a>
              </li>
              <li>
                <a target=""href='/music/' title="Music anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//000000/000036_hr1.webp'">
                  <span data-translate="Navbar_Music">Music</span>
                </a>
              </li>
              <li>
                <a target=""href='/dalamud/' title="Dalamud anzeigen">
                  <img loading="lazy" src='/assets/img/dalamud.webp' alt="">
                  <span data-translate="Navbar_Dalamud">Dalamud</span>
                </a>
              </li>
              <li>
                <a target=""href='/links/' title="Links anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061834_hr1.webp'">
                  <span data-translate="Navbar_Links">Links</span>
                </a>
              </li>
            </ul>
            <li style="cursor: pointer;"><span><span>&#9654;</span> Instance Content</span></li>
            <ul >
              <li>
                <a target=""href='/' title="Alle Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061540_hr1.webp'">
                  <span data-translate="Navbar_All Guides">All Guides</span>
                </a>
              </li>
              <li>
                <a target=""href='/dungeons/' title="Dungeon - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061801_hr1.webp'">
                  <span data-translate="Navbar_Dungeons">Dungeons</span>
                </a>
              </li>
              <li>
                <a target=""href='/trials/' title="Prüfung - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061804_hr1.webp'">
                  <span data-translate="Navbar_Trials">Trials</span>
                </a>
              </li>
              <li>
                <a target=""href='/raids/' title="Raid - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061802_hr1.webp'">
                  <span data-translate="Navbar_Raids">Raids</span>
                </a>
              </li>
              <li>
                <a target=""href='/ultimates/' title="Ultimate - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061832_hr1.webp'">
                  <span data-translate="Navbar_Ultimate Raids">Ultimate Raids</span>
                </a>
              </li>
              <li>
                <a target=""href='/allianzraid/' title="Allianz Raid - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061844_hr1.webp'">
                  <span data-translate="Navbar_Alliance Raids">Alliance Raids</span>
                </a>
              </li>
              <li>
                <a target=""href='/chaosallianzraid/' title="Chaos Allianz Raid - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061850_hr1.webp'">
                  <span data-translate="Navbar_Chaos Alliance Raids">Chaos Alliance Raids</span>
                </a>
              </li>
              <li>
                <a target=""href='/gewölbesuche/' title="Gewölbesuche - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061846_hr1.webp'">
                  <span data-translate="Navbar_Varient & Criterion Dungeon">Varient & Criterion Dungeon</span>
                </a>
              </li>
              <li>
                <a target=""href='/feldexkursion/' title="Feldexkursion - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061837_hr1.webp'">
                  <span data-translate="Navbar_Field Operations">Field Operations</span>
                </a>
              </li>
              <li>
                <a target=""href='/bluemage/' title="Bluemage - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061836_hr1.webp'">
                  <span data-translate="Navbar_Blue Mage">Blue Mage</span>
                </a>
              </li>
              <li>
                <a target=""href='/potd/' title="Tiefes Gewöbe - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061824_hr1.webp'">
                  <span data-translate="Navbar_Deep Dungeon">Deep Dungeon</span>
                </a>
              </li>
              <li>
                <a target=""href='/guildhest/' title="Gildengeheiße - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061803_hr1.webp'">
                  <span data-translate="Navbar_Guildhests">Guildhests</span>
                </a>
              </li>
              <li>
                <a target=""href='/treasure/' title="Schatzdungeon - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061808_hr1.webp'">
                  <span data-translate="Navbar_Treasure Dungeon">Treasure Dungeon</span>
                </a>
              </li>
              <li>
                <a target=""href='/pvp/' title="PVP - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061806_hr1.webp'">
                  <span data-translate="Navbar_PVP">PVP</span>
                </a>
              </li>
              <li>
                <a target=""href='/training/' title="Training - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//061000/061823_hr1.webp'">
                  <span data-translate="Navbar_Training">Training</span>
                </a>
              </li>
              <li>
                <a target=""href='/overworld/' title="Overworld - Guides anzeigen">
                  <img loading="lazy" src='/assets/img/game_assets//052000/052474_hr1.webp'">
                  <span data-translate="Navbar_Overworld">Overworld</span>
                </a>
              </li>
            </ul>
          </ul>
        </div>
      </div>
      <!-- END Include from _includes/navbar -->
      <div class="layout__wrapper">
        <!-- Include from _includes/header -->
        <header>
          <div class="site-header__grid" loading="lazy"style="background-image:url('/assets/img/content/klassen/Chocobo.webp');">
            <div></div>
            <div class="site-header__item-a">
              <h1 class="site-header__title">
                <span data-translate="Header_CatTitle_"></span><span class="lang-toggle lang-toogle-en">Timeworn Peisteskin Map</span><span class="lang-toggle lang-toogle-de">Vergilbte Basiliskenleder-Karte</span><span class="lang-toggle lang-toogle-fr">Vieille carte en peau de peiste</span><span class="lang-toggle lang-toogle-ja">古ぼけた地図G5</span><span class="lang-toggle lang-toogle-cn"></span><span class="lang-toggle lang-toogle-ko"></span></h1>
              <h2 class="lang-toggle lang-toogle-en-sub site-header__guide-title_en">Timeworn Peisteskin Map</h2>
            </div>
            <ul
                class="site-header__links">
              <li>
                <a href="https://twitter.com/intent/tweet?via=Akurosia&url=%2Ftreasuremap%2Fvergilbte-basiliskenleder-karte.html&text=I%20want%20to%20submit%20feedback%20on%20%7B%22de%22%3D%3E%22Vergilbte+Basiliskenleder-Karte%22%2C+%22en%22%3D%3E%22Timeworn+Peisteskin+Map%22%2C+%22fr%22%3D%3E%22Vieille+carte+en+peau+de+peiste%22%2C+%22ja%22%3D%3E%22%E5%8F%A4%E3%81%BC%E3%81%91%E3%81%9F%E5%9C%B0%E5%9B%B3G5%22%7D%2E&related=Akurosia, ffxiv_pocket_guide" target="_blank" rel="noopener noreferrer" title="Sende Feedback für Vergilbte Basiliskenleder-Karte.">
                  <ion-icon name="logo-twitter"></ion-icon>
                  <span data-translate="Header_SendFeedback">Send Feedback</span>
                </a>
              </li>
              <li></li>
            </ul>
          </div>
          <div style="display: none" data-extra-translate="/assets/translations/header"></div>
          <div style="display: none" data-extra-translate="/assets/translations/expansions"></div>
        </header>
        <!-- END Include from _includes/header -->
        <!-- Include from _includes/treasuremap/guide-layout -->
        <!-- Guide Layout ========================================================== -->
        <div class="guide-layout"><!-- Include from _includes/guide-sidebar -->
          <!-- Guide Metadata ======================================================== -->
          <div class="guide-metadata">
            <div id="mapimagepreview" class="mapimagepreview"></div>
            <div style="display: none;"></div>
            <div class="guide-metadata__wrapper">
              <h5 class="guide-metadata__subtitle akuflex box small-1of2 med-full">
                <div data-translate="Sidebar_PlayerLevel">Player Level: </div>
                <span class="noblock">50</span>
              </h5>
              <h5 class="guide-metadata__subtitle akuflex box small-1of2 med-full">
                <div data-translate="Sidebar_ItemLevel">Item Level: </div>
                <span class="noblock">N/A</span
            ></h5>
              <h5 class="guide-metadata__subtitle akuflex box small-1of2 med-full">
                <div data-translate="Sidebar_Patch">Patch:</div>
                <span class="block"  data-translate="Patch_2.1 - A Realm Awoken">2.1 - A Realm Awoken</span></h5>
              <!-- Only on Classes --><!-- END Only on Classes -->
              <!-- Only on Content -->
              <h5 class="guide-metadata__subtitle akuflex box small-1of2 med-full">
                <div data-translate="Sidebar_MaxPartySize">MaxPartySize: </div>
                <span data-translate="maxpartysize_">8</span>
              </h5>
            </div>
            <div style="display: none" data-extra-translate="/assets/translations/sidebar"></div>
          </div>
          <!-- END Include from _includes/guide-sidebar -->
          <!-- Include from _includes/treasuremap/guide-content -->
          <!-- Guide Content ========================================================= -->
          <div class="guide-content">
            <!-- Duty zones ======================================================= --><!-- Include from _includes/treasuremap/guide-enemy -->
            <!-- Guide Adds ========================================================== -->
            <div class="guide__accordion">
              <div class="guide__accordion-trigger--01-grid active" id="guideZones">
                <div class="Names">
                  <span class="guide__accordion-trigger-title class" data-translate="Map_Title_Zones">Zones</span>
                  <span class="lang-toggle lang-toogle-en-sub guide__accordion-trigger-title_en xtitle">Zones</span>
                </div>
              </div>
              <!-- Guide Event Accordion Content -->
              <div class="guide__accordion-content--01 active">
                <!-- Opens the Adds Loop --><!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-central-shroud">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Central Shroud">Central Shroud</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/central-shroud.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Tiefer Wald/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-east-shroud">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_East Shroud">East Shroud</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/east-shroud.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Ostwald/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-south-shroud">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_South Shroud">South Shroud</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/south-shroud.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südwald/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-north-shroud">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_North Shroud">North Shroud</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/north-shroud.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nordwald/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-middle-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Middle La Noscea">Middle La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/middle-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-lower-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Lower La Noscea">Lower La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/lower-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Unteres La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-eastern-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Eastern La Noscea">Eastern La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/eastern-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-western-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Western La Noscea">Western La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/western-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-upper-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Upper La Noscea">Upper La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/upper-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Oberes La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-outer-la-noscea">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Outer La Noscea">Outer La Noscea</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/outer-la-noscea.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Äußeres La Noscea/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-western-thanalan">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Western Thanalan">Western Thanalan</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/western-thanalan.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Westliches Thanalan/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-central-thanalan">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Central Thanalan">Central Thanalan</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/central-thanalan.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Thanalan/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-eastern-thanalan">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Eastern Thanalan">Eastern Thanalan</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/eastern-thanalan.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Östliches Thanalan/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-southern-thanalan">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Southern Thanalan">Southern Thanalan</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/southern-thanalan.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Südliches Thanalan/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-northern-thanalan">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Northern Thanalan">Northern Thanalan</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/northern-thanalan.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Nördliches Thanalan/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-coerthas-central-highlands">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Coerthas Central Highlands">Coerthas Central Highlands</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/coerthas-central-highlands.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Zentrales Hochland von Coerthas/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Opens the Sequence Loop -->
                <div class="guide-metadata__menu-link guide__accordion-trigger--03--grid" id="map-mor-dhona">
                  <i class="Dropdown material-icons"><ion-icon size="large" name="chevron-down-outline" style="color: white !important"></ion-icon></i>
                  <div class="Names klassen">
                    <h3 class="guide__accordion-trigger-title" data-translate="Map_Section_Mor Dhona">Mor Dhona</h3>
                  </div>
                </div>
                <div class="guide__accordion-content--03">
                  <span>/assets/leaflet/maps/mor-dhona.json</span>
                  <head>
                    <link rel="stylesheet" href="https://akutrack.akurosia.org/assets/css/filter.css" />
                    <style>
                      @font-face {
                        font-family: "finalf";
                        src: url("https://akutrack.akurosia.org/assets/FFXIV_Lodestone_SSF.ttf") format("truetype");
                        font-weight: normal;
                        font-style: normal;
                        font-display: swap;
                      }

                      /* Keep your Leaflet popup too */
                      .leaflet-popup-content-wrapper,
                      .leaflet-popup-content-wrapper * {
                        font-family: "finalf", Arial, Helvetica, sans-serif !important;
                      }
                      .tg th, .tg td{border-color:rgb(75, 75, 75);border-style:solid;border-width:1px;}

                      /* Layout: filters left, map right */
                      .akutrack_layout {
                          display: flex;
                          gap: 12px;
                          align-items: stretch;
                      }

                      .akutrack_sidebar {
                          width: 360px;
                          max-width: 40vw;
                          min-width: 280px;
                          height: 800px;
                          overflow: auto;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          padding: 10px;
                          box-sizing: border-box;
                          background: #fff;
                      }

                      .mapwrap {
                          flex: 1;
                          min-width: 320px;
                          height: 800px;
                          border: 1px solid rgba(0, 0, 0, 0.15);
                          border-radius: 8px;
                          overflow: hidden;
                          background: #000;
                      }

                      /* Leaflet container must fill */
                      #map {
                          width: 100%;
                          height: 100%;
                      }

                      .map_type_filters {
                          border: 1px solid var(--border);
                          border-radius: 12px;
                          padding: 12px;
                          background: rgba(0, 0, 0, .18);
                      }

                      .filters-head {
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          gap: 10px;
                          margin-bottom: 10px;
                      }

                      .filters-actions {
                          display: flex;
                          gap: 8px;
                          flex-wrap: wrap
                      }

                      .field {
                          display: none;
                      }

                      .btn {
                          appearance: none;
                          border: 1px solid rgba(0, 0, 0, 0.2);
                          background: #f6f6f6;
                          border-radius: 6px;
                          padding: 4px 8px;
                          cursor: pointer;
                          font: 12px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
                      }

                      .btn:hover {
                          background: #ededed;
                      }

                      /* maps.filter.js / maps.app.js will populate this */
                      #map_type_filters {
                          display: grid;
                          gap: 6px;
                      }

                      /* keep embed controls out of view but present for maps.* logic */
                      .hidden-controls {
                          display: none;
                      }
                    </style>
                  </head>
                  <div class="akutrack_layout">
                    <!-- LEFT: filter UI -->
                    <aside class="akutrack_sidebar">
                      <div class="filters-head">
                        <h3>Filters</h3>
                        <div >
                          <select class="hidden-controls" id="expansion_selector"></select>
                          <select class="hidden-controls" id="region_selector"></select>
                          <select class="hidden-controls" id="zone_selector"></select>
                          <select class="hidden-controls" id="map_selector"></select>
                          <select class="hidden-controls" id="version_selector"></select>
                          <input class="hidden-controls" id="mid" />
                          <!-- maps.app.js uses this to sync selected map -> #mid -->
                          <button class="hidden-controls" id="copy_to_filter" type="button">copy</button>
                        </div>
                        <div class="filters-actions">
                          <button id="map_types_all" class="btn" type="button">All</button>
                          <button id="map_types_none" class="btn" type="button">None</button>
                        </div>
                      </div>
                      <div id="map_type_filters">
                      </div>
                    </aside>
                    <!-- RIGHT: map -->
                    <main class="mapwrap">
                      <div id="map">
                      </div>
                    </main>
                  </div>
                  <!-- Your scripts (keep order) -->
                  <script src="https://akutrack.akurosia.org/assets/js/helper.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/popup.js" defer></script>
                  <script src="https://akutrack.akurosia.org/assets/js/maps.js" defer></script>
                  <script >
                    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
                    async function waitUntil(fn, timeoutMs = 15000, intervalMs = 50) {
                        const start = Date.now();
                        while (Date.now() - start < timeoutMs) {
                            const v = fn();
                            if (v) return v;
                            await sleep(intervalMs);
                        }
                        return null;
                    }

                    function setSelectValue(sel, value) {
                        if (!sel) return false;
                        const v = String(value ?? "");
                        if (!v) return false;
                        const ok = Array.from(sel.options || []).some(o => String(o.value) === v);
                        if (!ok) return false;
                        sel.value = v;
                        sel.dispatchEvent(new Event("change", {
                            bubbles: true
                        }));
                        return true;
                    }

                    function parseMidFromUrl(url) {
                        try {
                            const u = new URL(url, location.href);
                            const mid = u.searchParams.get("mid");
                            return mid == null ? null : Number(mid);
                        } catch {
                            return null;
                        }
                    }
                    // Prevent the “random mid” requests during selector-cascade by blocking api.php calls
                    // unless they are for the target mid.
                    function installApiMidGate(targetMid) {
                        if (window.__akutrack_fetch_gate_installed) return () => {};
                        window.__akutrack_fetch_gate_installed = true;
                        const origFetch = window.fetch.bind(window);
                        window.__akutrack_fetch_gate_enabled = false;
                        window.__akutrack_fetch_gate_mid = Number(targetMid);
                        window.fetch = async (input, init) => {
                            const url = typeof input === "string" ? input : (input && input.url) ? input.url : "";
                            if (window.__akutrack_fetch_gate_enabled && url && url.includes("api.php")) {
                                const mid = parseMidFromUrl(url);
                                const target = Number(window.__akutrack_fetch_gate_mid);
                                // Allow only the target mid while gate is enabled
                                if (Number.isFinite(mid) && mid !== target) {
                                    // Return an empty successful response so callers don't throw
                                    return new Response("[]", {
                                        status: 200,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                    });
                                }
                            }
                            return origFetch(input, init);
                        };
                        return () => {
                            window.fetch = origFetch;
                            window.__akutrack_fetch_gate_enabled = false;
                            window.__akutrack_fetch_gate_installed = false;
                        };
                    }
                    // Public helper: only takes rowId, uses cfg.imageUrl from your map config
                    async function forceMapBackgroundByRowId(rowId) {
                        const rid = Number(rowId);
                        await waitUntil(() => {
                            const expSel = document.getElementById("expansion_selector");
                            return expSel && expSel.options && expSel.options.length > 0;
                        });
                        const cfg = await waitUntil(() => {
                            const maps = state.MAPS || [];
                            return maps.find(m => Number(m?.row_id) === rid) || null;
                        });
                        if (!cfg) throw new Error("No map config found with row_id: " + rid);
                        const url = String(cfg.imageUrl ?? "").trim();
                        if (!url || url.toLowerCase() === "undefined") {
                            throw new Error("cfg.imageUrl is empty/undefined for row_id " + rid);
                        }
                        // Install fetch gate to avoid intermediate mid requests during the selector cascade
                        const uninstallGate = installApiMidGate(rid);
                        window.__akutrack_fetch_gate_mid = rid;
                        window.__akutrack_fetch_gate_enabled = true;
                        try {
                            // Drive the existing selection pipeline so maps.app.js uses the correct cfg for transforms
                            const expSel = document.getElementById("expansion_selector");
                            const regSel = document.getElementById("region_selector");
                            const plcSel = document.getElementById("zone_selector");
                            const mapSel = document.getElementById("map_selector");
                            const verSel = document.getElementById("version_selector");
                            // Expansion
                            setSelectValue(expSel, cfg.expansionLabel);
                            await sleep(0);
                            // Region
                            await waitUntil(() => regSel && regSel.options && regSel.options.length > 0);
                            setSelectValue(regSel, cfg.regionLabel);
                            await sleep(0);
                            // Place/Zone
                            await waitUntil(() => plcSel && plcSel.options && plcSel.options.length > 0);
                            setSelectValue(plcSel, cfg.placeLabel);
                            await sleep(0);
                            // Version/Sub id (cfg.id like "o6b1/01")
                            await waitUntil(() => {
                                const hasVer = verSel && Array.from(verSel.options || []).some(o => String(o.value) === String(cfg.id));
                                const hasMap = mapSel && Array.from(mapSel.options || []).some(o => String(o.value) === String(cfg.id));
                                return hasVer || hasMap;
                            });
                            if (!setSelectValue(verSel, cfg.id)) {
                                setSelectValue(mapSel, cfg.id);
                            }
                            await sleep(0);
                            // Now allow only the final target mid request by setting #mid explicitly
                            const midEl = document.getElementById("mid");
                            if (midEl) {
                                midEl.value = String(rid);
                                midEl.dispatchEvent(new Event("change", {
                                    bubbles: true
                                }));
                            }
                            // Ensure overlay uses cfg.imageUrl (maps.app.js should do this; this guarantees it)
                            await sleep(0);
                            if (state.overlay?.setUrl) state.overlay.setUrl(url);
                            console.log("Switched to cfg:", {
                                id: cfg.id,
                                row_id: cfg.row_id,
                                imageUrl: url
                            });
                            return cfg;
                        } finally {
                            // Disable gating after the map switch finished
                            await sleep(100);
                            window.__akutrack_fetch_gate_enabled = false;
                            void uninstallGate;
                        }
                    }
                    async function maybeshowfields(){
                        await sleep(3000)
                        const map_selector = document.getElementById("map_selector");
                        const version_selector = document.getElementById("version_selector");

                        if (map_selector && map_selector.options.length > 1) {
                          map_selector.classList.remove("hidden-controls");
                        }

                        if (version_selector && version_selector.options.length > 1) {
                          version_selector.classList.remove("hidden-controls");
                        }
                    }
                    const TARGET_ROW_ID = ;
                    document.addEventListener("DOMContentLoaded", () => {
                        let storedMid = NaN;
                        try {
                            const raw = localStorage.getItem("duckit_settings_v1");
                            const obj = raw ? JSON.parse(raw) : null;
                            storedMid = Number(obj?.mid);
                        } catch {
                            storedMid = NaN;
                        }
                        if (!Number.isFinite(storedMid) || storedMid !== Number(TARGET_ROW_ID)) {
                            forceMapBackgroundByRowId(Number(TARGET_ROW_ID)).catch(console.error);
                        }
                        maybeshowfields()
                    });
                  </script>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/A.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/A.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/B.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/B.webp"/>
                    </div>
                    <div class="guide__attack-image-item">
                      <img loading="lazy" style="object-fit: scale-down; height: 200px; cursor: pointer;" src="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/C.webp" alt="/assets/img/TreasureMaps/Vergilbte Basiliskenleder-Karte/Mor Dhona/C.webp"/>
                    </div>
                  </div>
                </div>
                <!-- END Include from _includes/treasuremap/guide_enemy_sequence -->
                <!-- Include from _includes/_components/image_overlay -->
                <div style="display: none" class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
                  <img id="fullscreenImg" src="" alt="Fullscreen View">
                </div>
                <!-- END Include from _includes/_components/image_overlay -->
              </div>
            </div>
            <!-- END Include from _includes/treasuremap/guide-enemy -->
            <div style="display: none" data-extra-translate="/assets/translations/treasuremaps"></div>
          </div>
          <!-- END Include from _includes/treasuremap/guide-content -->
        </div>
        <!-- END Include from _includes/treasuremap/guide-layout -->
        <!-- Include from _includes/footer -->
        <footer>
          <div class="content-container">
            <p class="footer__copy">
              <span data-translate="Footer_ProducedBy">This site is produced by </span>
              <a href="https://de.finalfantasyxiv.com/lodestone/character/7944237/" target="_blank" rel="noopener noreferrer" title="Visit Akurosia Kamo on the Lodestone.">Akurosia Kamo</a>
              <span data-translate="Footer_WithHelp">with the help of video guides created by </span>
              <a href="https://twitter.com/MTQcapture" title="Go to MTQcapture's Twitter." target="_blank" rel="noopener noreferrer">@MTQcapture</a>
              <span data-translate="Footer_And"> and </span>
              <a href="https://twitter.com/mrhappy1227" title="Go to MrHappy1227's Twitter." target="_blank" rel="noopener noreferrer">@MrHappy1227</a>.
            </br></br>
          <span data-translate="Footer_ProducedByOriginal">The original Page was created by </span>
          <a href="https://twitter.com/lionsliege" target="_blank" rel="noopener noreferrer" title="Visit Liege on Twitter.">@LionsLiege</a>,
          <a href="https://na.finalfantasyxiv.com/lodestone/character/12774809/" target="_blank" rel="noopener noreferrer" title="Visit Demosthenes on the Lodestone.">Demosthenes Lorelai</a>,
          <a href="https://na.finalfantasyxiv.com/lodestone/character/14514962/" target="_blank" rel="noopener noreferrer" title="Visit Divine on the Lodestone.">Divine Angel</a>,
          <span data-translate="Footer_And"> and </span>
          <a href="https://na.finalfantasyxiv.com/lodestone/character/3758032/" target="_blank" rel="noopener noreferrer" title="Visit Shiro on the Lodestone.">Shiro Astral</a>
        </br>
        <span data-translate="Footer_OriginalPageLinks">Original Page Link: </span>
        <a href="https://ffxiv.guide/" title="Original Page Link" target="_blank" rel="noopener noreferrer">https://ffxiv.guide/</a>
        <br>
        <span data-translate="Footer_LastUpdated">Last updated: </span>2026-02-06 17:07:43 -0600</span><br>
      <a href="https://github.com/Akurosia/DevFFXIVPocketGuide" target="_blank" rel="noopener noreferrer" title="Pocket Guide Development Repo!">
        <ion-icon name="logo-github"></ion-icon>
        <span data-translate="Footer_ViewOnGithub">View Project on Github</span>
      </a>
    </p>
  </div>
  <div style="display: none" data-extra-translate="/assets/translations/footer"></div>
</footer>
<script type="text/javascript" src="/assets/js/expand_collapse.js?1770419310945723427"></script>
<!-- END Include from _includes/footer -->
</div>
</div>
<div style="display: none" data-extra-translate="/assets/translations/treasuremaps"></div>
<!-- Include from _includes/scripts -->
<!-- Match Media -->
<script type="text/javascript" src="/assets/vendor/matchMedia.js"></script>
<!-- Custom Scripts -->
<script type="text/javascript" src="/assets/js/core.js"></script>
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/openEnemy.js"></script>
<script type="text/javascript" src="/assets/js/ionicons740/ionicons.esm.js"></script>
<script type="text/javascript" src="/assets/js/ionicons740/ionicons.js"></script>
<!-- <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script> -->
<!-- <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script> -->
<!-- END Include from _includes/scripts -->
</body>
<!-- END ORIGIN: _layout/treasuremap -->
<script type="text/javascript">
  executeHandelingLanguages()
</script>
</html>